<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NUEVA√ëO | Zaher Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&family=Great+Vibes&family=Bangers&display=swap');
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding-bottom: 90px;
            overflow-x: hidden;
        }

        .logo-font { font-family: 'Great Vibes', cursive; }
        .comic-font { font-family: 'Bangers', cursive; letter-spacing: 1px; }
        
        .gradient-text {
            background: linear-gradient(135deg, #a855f7, #ec4899, #f43f5e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-blur {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- COMIC SYSTEM --- */
        .comic-bubble-pop {
            background: white;
            color: black;
            border: 3px solid black;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            box-shadow: 6px 6px 0px #a855f7;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: rotate(-1deg);
            z-index: 100;
        }

        @keyframes popIn {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            100% { transform: scale(1) rotate(-1deg); opacity: 1; }
        }

        #mascot-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 100px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #mascot-overlay.active { opacity: 1; pointer-events: all; }

        .comic-bubble-big {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 15px;
            border-radius: 20px;
            position: relative;
            max-width: 250px;
            box-shadow: 8px 8px 0px #a855f7;
            margin-bottom: 20px;
            transform: rotate(-2deg);
        }

        .stickman-comic { 
            width: 80px; 
            height: 100px; 
            filter: drop-shadow(4px 4px 0px #000);
        }
        .stickman-comic line, .stickman-comic circle { 
            stroke: white; 
            stroke-width: 8; 
            fill: none; 
            stroke-linecap: round; 
        }

        /* Side triggers */
        .side-trigger {
            position: fixed;
            top: 0;
            bottom: 80px;
            width: 30px;
            z-index: 900;
            cursor: help;
        }
        .left-trigger { left: 0; }
        .right-trigger { right: 0; }

        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 75px;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1); display: flex;
            justify-content: space-around; align-items: center; z-index: 500;
        }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #666; font-size: 10px; cursor: pointer; }
        .tab-item.active { color: #fff; }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #a855f7; padding: 12px 24px; border-radius: 50px;
            font-size: 12px; font-weight: bold; transition: transform 0.4s; z-index: 1100;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        .view-content { display: none; }
        .view-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .helper-tag {
            background: #fff; color: #000; font-weight: 800; font-size: 10px;
            padding: 4px 10px; border-radius: 6px; border: 2px solid #000;
            box-shadow: 3px 3px 0px #ec4899; display: inline-block; margin: 2px;
        }

        .batch-label {
            font-size: 9px;
            color: #ec4899;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
            display: block;
        }

        /* Burn animation */
        .burning { animation: burn 0.5s infinite alternate; }
        @keyframes burn {
            from { text-shadow: 0 0 10px #f87171; transform: translateY(0); }
            to { text-shadow: 0 0 20px #ef4444; transform: translateY(-5px); }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- Splash -->
    <div id="splash" class="fixed inset-0 bg-black z-[2000] flex flex-col items-center justify-center transition-opacity duration-700">
        <h1 class="logo-font text-6xl gradient-text">A√±o Nuevo Venezuela</h1>
        <p class="text-[10px] tracking-widest text-gray-500 mt-4 uppercase">C√∫a, Miranda 2026</p>
    </div>

    <div class="side-trigger left-trigger" onclick="showMascot()"></div>
    <div class="side-trigger right-trigger" onclick="showMascot()"></div>

    <div id="mascot-overlay" onclick="hideMascot()">
        <div class="flex flex-col items-center">
            <div class="comic-bubble-big">
                <p id="mascot-text" class="comic-font text-xl text-center"></p>
            </div>
            <svg class="stickman-comic" viewBox="0 0 100 120">
                <circle cx="50" cy="30" r="12" />
                <line x1="50" y1="42" x2="50" y2="75" />
                <line x1="50" y1="48" x2="20" y2="40" />
                <line x1="50" y1="48" x2="80" y2="65" />
                <line x1="50" y1="75" x2="35" y2="105" />
                <line x1="50" y1="75" x2="65" y2="105" />
            </svg>
        </div>
    </div>

    <div id="toast">Cargando...</div>

    <div class="max-w-md mx-auto p-6 pt-12">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-2xl font-bold">¬°Epa, Zaher! üëã</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-tighter italic">C√∫a, Miranda</p>
            </div>
            <div class="relative cursor-pointer" onclick="changeView('inbox')">
                <i class="far fa-comment-dots text-xl"></i>
                <span id="badge-inbox" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
            </div>
        </header>

        <section id="view-explore" class="view-content active">
            <!-- Nav de Tradiciones -->
            <div class="flex gap-5 overflow-x-auto pb-6 no-scrollbar">
                <div onclick="selectTradition('hallaca')" class="flex flex-col items-center gap-2 flex-shrink-0 cursor-pointer group">
                    <div id="nav-hallaca-ring" class="w-14 h-14 rounded-full p-[2px] bg-gradient-to-tr from-green-400 to-yellow-500">
                        <div class="w-full h-full rounded-full bg-black border-2 border-black flex items-center justify-center">ü´î</div>
                    </div>
                    <span class="text-[8px] font-bold text-gray-400 uppercase">Hallacas</span>
                </div>
                <div onclick="selectTradition('maleta')" class="flex flex-col items-center gap-2 flex-shrink-0 cursor-pointer group">
                    <div id="nav-maleta-ring" class="w-14 h-14 rounded-full p-[2px] bg-white/10">
                        <div class="w-full h-full rounded-full bg-black border-2 border-black flex items-center justify-center">üß≥</div>
                    </div>
                    <span class="text-[8px] font-bold text-gray-400 uppercase">Maleta</span>
                </div>
                <div onclick="selectTradition('uvas')" class="flex flex-col items-center gap-2 flex-shrink-0 cursor-pointer group">
                    <div id="nav-uvas-ring" class="w-14 h-14 rounded-full p-[2px] bg-white/10">
                        <div class="w-full h-full rounded-full bg-black border-2 border-black flex items-center justify-center">üçá</div>
                    </div>
                    <span class="text-[8px] font-bold text-gray-400 uppercase">Uvas</span>
                </div>
                <div onclick="selectTradition('anoviejo')" class="flex flex-col items-center gap-2 flex-shrink-0 cursor-pointer group">
                    <div id="nav-anoviejo-ring" class="w-14 h-14 rounded-full p-[2px] bg-white/10">
                        <div class="w-full h-full rounded-full bg-black border-2 border-black flex items-center justify-center">üî•</div>
                    </div>
                    <span class="text-[8px] font-bold text-gray-400 uppercase">Fog√≥n</span>
                </div>
            </div>

            <div class="card-blur rounded-[2.5rem] p-6 min-h-[500px] flex flex-col relative border-t border-white/10 shadow-2xl overflow-hidden">
                <div id="helpers-panel" class="mb-4 hidden">
                    <p class="text-[9px] font-black text-pink-500 uppercase tracking-widest mb-2">¬øQui√©nes han puesto pa¬¥ las hallacas?</p>
                    <div id="helpers-list" class="space-y-4"></div>
                </div>

                <div id="sub-menu" class="flex gap-2 mb-6 overflow-x-auto no-scrollbar"></div>
                
                <div id="main-content" class="flex-1 flex flex-col items-center justify-center text-center"></div>
            </div>
        </section>

        <!-- CHAT SECTION -->
        <section id="view-inbox" class="view-content">
            <h2 class="comic-font text-3xl mb-6">NOTIFICACIONES</h2>
            <div id="inbox-list" class="space-y-3"></div>
        </section>

        <!-- PROFILE SECTION -->
        <section id="view-profile" class="view-content">
            <h2 class="comic-font text-3xl mb-6">PERFIL</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="card-blur p-5 rounded-3xl">
                    <p class="comic-font text-2xl" id="stat-hallacas">0</p>
                    <p class="text-[8px] text-gray-400 uppercase font-bold">Hallacas</p>
                </div>
                <div class="card-blur p-5 rounded-3xl">
                    <p class="comic-font text-2xl" id="stat-grapes">0</p>
                    <p class="text-[8px] text-gray-400 uppercase font-bold">Uvas</p>
                </div>
            </div>
        </section>
    </div>

    <nav class="tab-bar">
        <div onclick="changeView('explore')" class="tab-item active" id="tab-explore"><i class="fas fa-bolt mb-1"></i><span>INICIO</span></div>
        <div onclick="changeView('inbox')" class="tab-item" id="tab-inbox"><i class="fas fa-comment-dots mb-1"></i><span>CHAT</span></div>
        <div onclick="changeView('profile')" class="tab-item" id="tab-profile"><i class="fas fa-user mb-1"></i><span>YO</span></div>
    </nav>

    <script>
        let state = {
            hallacasCooked: 0,
            hallacasInBatch: 0,
            currentBatchIndex: 1,
            grapesEaten: 0,
            interactions: [],
            currentTradition: 'hallaca',
            helpersByBatch: { 1: new Set() },
            activeNote: null,
            // Hallacas - Initial Testing State: All checked
            ingredients: {
                "Harina PAN": { donor: "Naiwei", note: "¬°Masa suavecita!", ok: true, batch: 1 },
                "Carne": { donor: "T√≠a Maria", note: "Guiso de C√∫a", ok: true, batch: 1 },
                "Hojas": { donor: "El Abuelo", note: "Limpias y ahumaditas", ok: true, batch: 1 },
                "Ali√±os": { donor: "Primo Luis", note: "Directo del mercado", ok: true, batch: 1 }
            },
            // Maleta
            destinos: [
                { name: "Cataratas del Iguaz√∫", donor: "Yo", note: "¬°Meta personal!", packing: true },
                { name: "Par√≠s", donor: "Naiwei", note: "¬°Me llevas en la maleta!", packing: false }
            ],
            maletaCerrada: false,
            // Uvas
            uvas: Array.from({length: 12}, (_, i) => ({
                id: i,
                eaten: false,
                type: i % 3 === 0 ? 'green' : 'purple',
                donor: i % 3 === 0 ? "Pana de C√∫a" : "Yo",
                wish: i % 3 === 0 ? "¬°Mucha salud y √©xito!" : "..."
            })),
            // Fog√≥n
            quemar: "",
            deseos2026: []
        };

        // Initialize Batch 1 helpers based on initial state
        Object.values(state.ingredients).forEach(ing => {
            if(ing.ok) state.helpersByBatch[1].add(ing.donor);
        });

        const tips = {
            hallaca: "Aqui si hay que pedir apoyo... ¬øQuien pone pa¬¥las hallacas?",
            maleta: "Mete en tu maleta tus tickets de viaje y dale la vuelta al mundo... Otros amigos pueden mandarte mensajes finos de viaje, o tickets para que viajen juntos",
            uvas: "Tus deseos son las uvas moradas... Los deseos de tus panas para tu vida las verdes",
            anoviejo: "ESCRIBE TODO LO QUE TE HAYA SALIDO MAL, Y LUEGO TU MAYOR DESEO PARA ESTE A√ëO VENIDERO"
        };

        // --- CORE UI ---
        function showMascot() {
            document.getElementById('mascot-text').innerText = tips[state.currentTradition];
            document.getElementById('mascot-overlay').classList.add('active');
        }
        function hideMascot() { document.getElementById('mascot-overlay').classList.remove('active'); }
        
        function changeView(id) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(`view-${id}`).classList.add('active');
            document.getElementById(`tab-${id}`).classList.add('active');
        }

        function sendAction(msg, isChat = false) {
            const toast = document.getElementById('toast');
            if(!toast) return;
            toast.innerText = msg; toast.classList.add('show');
            state.interactions.unshift({ msg, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), isChat });
            updateInbox();
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function updateInbox() {
            const list = document.getElementById('inbox-list');
            if(!list) return;
            const badge = document.getElementById('badge-inbox');
            if(badge) badge.classList.remove('hidden');
            list.innerHTML = state.interactions.map(i => `
                <div class="card-blur p-4 rounded-2xl border-l-4 ${i.isChat ? 'border-pink-500' : 'border-purple-500'} mb-2">
                    <p class="text-[8px] text-gray-500">${i.time}</p>
                    <p class="text-xs font-bold uppercase">${i.msg}</p>
                </div>`).join('');
        }

        // --- TRADITION RENDERERS ---
        const renderers = {
            hallaca: (mode) => {
                const content = document.getElementById('main-content');
                if(mode === 0) {
                    content.innerHTML = `
                    <div class="w-full text-left relative">
                        ${state.activeNote ? `
                        <div class="absolute inset-x-0 -top-10 z-50">
                            <div class="comic-bubble-pop" onclick="state.activeNote = null; renderers.hallaca(0)">
                                <p class="text-[8px] font-black text-gray-400">${state.activeNote.donor} dice:</p>
                                <p class="comic-font text-lg leading-tight">"${state.activeNote.note}"</p>
                            </div>
                        </div>` : ''}
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <p class="text-[10px] text-purple-400 font-bold uppercase">Tanda #${state.currentBatchIndex}</p>
                                <p class="text-[8px] text-gray-500 uppercase">Faltan ingredientes para las pr√≥ximas 6</p>
                            </div>
                            <button onclick="addIng()" class="text-[8px] bg-white/10 px-3 py-1 rounded-full hover:bg-white/20 transition-colors">A√±adir ingrediente</button>
                        </div>
                        <div class="space-y-2">
                            ${Object.keys(state.ingredients).map(ing => `
                                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5">
                                    <div class="cursor-pointer" onclick="state.activeNote = state.ingredients['${ing}']; renderers.hallaca(0)">
                                        <p class="text-sm font-bold">${ing}</p>
                                        <p class="text-[9px] text-gray-500">De: ${state.ingredients[ing].donor}</p>
                                    </div>
                                    <input type="checkbox" onchange="toggleIng('${ing}')" ${state.ingredients[ing].ok ? 'checked' : ''} class="w-5 h-5 accent-pink-500 cursor-pointer">
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                } else {
                    const ready = Object.values(state.ingredients).every(v => v.ok);
                    content.innerHTML = `
                    <div class="space-y-10 py-10">
                        <div class="text-7xl ${ready ? 'animate-bounce' : 'opacity-30'}">ü´î</div>
                        <div>
                            <p class="comic-font text-2xl">TOTAL: ${state.hallacasCooked}</p>
                            <p class="text-[10px] text-gray-500 uppercase font-black">Disponibles para amarrar: ${ready ? 6 : 0}</p>
                        </div>
                        <button onclick="cookHallaca()" class="${ready ? 'bg-gradient-to-r from-purple-600 to-pink-600' : 'bg-gray-800 text-gray-500'} px-10 py-4 rounded-3xl font-black comic-font text-xl shadow-lg active:scale-95 transition-transform">
                            AMARRAR 6 HALLACAS
                        </button>
                    </div>`;
                }
            },

            maleta: (mode) => {
                const content = document.getElementById('main-content');
                if(state.maletaCerrada) {
                    content.innerHTML = `
                    <div class="w-full flex flex-col items-center">
                        <div class="text-6xl mb-6 scale-90 opacity-50">üß≥</div>
                        <div class="comic-bubble-pop mb-6">
                            <p class="comic-font text-xl text-center">¬°A CORRER POR C√öA! üèÉüí®</p>
                            <button onclick="state.maletaCerrada=false; renderers.maleta(0)" class="text-[8px] mt-2 underline block mx-auto">Reabrir Maleta</button>
                        </div>
                    </div>`;
                    return;
                }

                content.innerHTML = `
                <div class="w-full text-left relative">
                    ${state.activeNote ? `
                    <div class="absolute inset-x-0 -top-10 z-50">
                        <div class="comic-bubble-pop" onclick="state.activeNote = null; renderers.maleta(0)">
                            <p class="text-[8px] font-black text-gray-400">${state.activeNote.donor} dice:</p>
                            <p class="comic-font text-lg leading-tight">"${state.activeNote.note}"</p>
                        </div>
                    </div>` : ''}
                    
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">¬øA d√≥nde vamos?</p>
                        <button onclick="addDestinoPrompt()" class="text-[8px] bg-white/10 px-3 py-1 rounded-full">+ A√±adir</button>
                    </div>

                    <div class="space-y-2 mb-6">
                        ${state.destinos.map((dest, idx) => `
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5">
                                <div class="cursor-pointer" onclick="state.activeNote = state.destinos[${idx}]; renderers.maleta(0)">
                                    <p class="text-sm font-bold">üìç ${dest.name}</p>
                                    <p class="text-[9px] text-gray-500">Sugerido por: ${dest.donor}</p>
                                </div>
                                <input type="checkbox" onchange="toggleDestino(${idx})" ${dest.packing ? 'checked' : ''} class="w-5 h-5 accent-blue-500 cursor-pointer">
                            </div>
                        `).join('')}
                    </div>

                    <button onclick="cerrarMaleta()" class="w-full bg-blue-600 p-4 rounded-2xl font-black comic-font uppercase text-white shadow-lg active:scale-95 transition-transform">Cerrar y Correr üèÉ</button>
                </div>`;
            },

            uvas: (mode) => {
                const content = document.getElementById('main-content');
                if(mode === 0) {
                    content.innerHTML = `
                    <div class="w-full relative">
                        ${state.activeNote ? `
                        <div class="absolute inset-x-0 -top-10 z-50">
                            <div class="comic-bubble-pop" onclick="state.activeNote = null; renderers.uvas(0)">
                                <p class="text-[8px] font-black text-gray-400">${state.activeNote.donor} dice:</p>
                                <p class="comic-font text-lg leading-tight">"${state.activeNote.wish}"</p>
                            </div>
                        </div>` : ''}
                        <div class="grid grid-cols-4 gap-4 bg-white/5 p-6 rounded-[2.5rem] mb-6">
                            ${state.uvas.map(u => `
                                <div onclick="eatGrape(${u.id})" class="cursor-pointer transition-all ${u.eaten ? 'opacity-20 scale-50' : 'hover:scale-110'}">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-lg border-2 ${u.type === 'green' ? 'bg-green-500/20 border-green-500' : 'bg-purple-900/40 border-purple-500'}">
                                        üçá
                                    </div>
                                </div>`).join('')}
                        </div>
                        <div class="card-blur p-4 rounded-2xl">
                            <p class="text-[9px] uppercase font-black text-purple-400 mb-1">Leyenda:</p>
                            <div class="flex gap-4 justify-center">
                                <span class="text-[8px] flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-purple-500"></div> PROPIOS</span>
                                <span class="text-[8px] flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> DE PANAS</span>
                            </div>
                        </div>
                    </div>`;
                } else {
                    content.innerHTML = `
                    <div class="w-full space-y-3">
                        <p class="text-[10px] text-left text-gray-500 font-bold uppercase">Mis 12 Deseos</p>
                        <div class="space-y-2 max-h-[350px] overflow-y-auto no-scrollbar pr-1">
                            ${state.uvas.map(u => `
                                <div class="bg-white/5 p-3 rounded-xl border border-white/5 flex gap-3 items-center">
                                    <span class="text-[10px] font-black text-purple-500">${u.id + 1}</span>
                                    <input type="text" onchange="saveWish(${u.id}, this.value)" value="${u.wish}" class="flex-1 bg-transparent border-none text-[12px] outline-none ${u.type === 'green' ? 'text-green-400' : 'text-white'}" ${u.type === 'green' ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
            },

            anoviejo: (mode) => {
                const content = document.getElementById('main-content');
                content.innerHTML = `
                <div class="w-full flex flex-col items-center">
                    <div class="text-7xl burning mb-8">üî•</div>
                    <div class="w-full card-blur p-6 rounded-[2rem] border-red-500/20">
                        <p class="comic-font text-xl text-red-500 mb-4">EL FOG√ìN DE C√öA</p>
                        <textarea id="burn-text" placeholder="¬øQu√© quieres quemar del 2025?" class="w-full bg-black/40 p-4 rounded-2xl text-xs outline-none border border-white/10 mb-4 h-24 focus:border-red-500/50 transition-colors" oninput="state.quemar = this.value">${state.quemar}</textarea>
                        <button onclick="burnIt()" class="w-full bg-red-600 p-4 rounded-2xl font-black comic-font uppercase text-white shadow-lg shadow-red-900/50 active:scale-95 transition-transform">¬°QUEMAR TODO! üß®</button>
                    </div>
                    <div class="mt-6 flex flex-wrap gap-2 justify-center">
                        ${state.deseos2026.map(d => `<span class="helper-tag">${d}</span>`).join('')}
                    </div>
                </div>`;
            }
        };

        // --- ACTIONS ---
        function addIng() {
            const ing = prompt("Nombre del ingrediente:");
            if (!ing) return;
            const donor = prompt("¬øQui√©n lo trajo?", "Un pana");
            if (!donor) return;
            const note = prompt("Mensaje de esta persona:", "¬°Pa' la tanda!");
            
            state.ingredients[ing] = { donor, note: note || "¬°Aporte!", ok: false, batch: state.currentBatchIndex };
            sendAction(`Se agreg√≥ ${ing} a la tanda #${state.currentBatchIndex}. üìã`);
            renderers.hallaca(0);
        }

        function toggleIng(ing) {
            state.ingredients[ing].ok = !state.ingredients[ing].ok;
            if(state.ingredients[ing].ok) {
                if(!state.helpersByBatch[state.currentBatchIndex]) state.helpersByBatch[state.currentBatchIndex] = new Set();
                state.helpersByBatch[state.currentBatchIndex].add(state.ingredients[ing].donor);
                sendAction(`¬°${state.ingredients[ing].donor} trajo ${ing}! ü´î`, true);
                updateHelpersPanel();
            } else {
                state.helpersByBatch[state.currentBatchIndex].delete(state.ingredients[ing].donor);
                updateHelpersPanel();
            }
            renderers.hallaca(0);
        }

        function cookHallaca() {
            const keys = Object.keys(state.ingredients);
            const ready = keys.length > 0 && Object.values(state.ingredients).every(v => v.ok);
            
            if(!ready) return sendAction("¬°Faltan ingredientes para completar la tanda!");
            
            state.hallacasCooked += 6;
            const stat = document.getElementById('stat-hallacas');
            if(stat) stat.innerText = state.hallacasCooked;
            sendAction("¬°TANDA LISTA! 6 hallacas amarradas. üç≤", true);
            
            // Prepare next batch
            state.currentBatchIndex++;
            state.helpersByBatch[state.currentBatchIndex] = new Set();
            Object.keys(state.ingredients).forEach(k => state.ingredients[k].ok = false);
            
            renderers.hallaca(1);
            updateHelpersPanel();
        }

        function addDestinoPrompt() {
            const name = prompt("¬øA d√≥nde quieres viajar en 2026?");
            if(!name) return;
            const donor = prompt("¬øQui√©n sugiere este viaje?", "Yo");
            const note = prompt("¬øPor qu√© este viaje?", "¬°Para conocer el mundo!");
            
            state.destinos.push({ name, donor: donor || "Yo", note: note || "Sin nota", packing: false });
            sendAction(`üìç Destino "${name}" a√±adido a la maleta.`);
            renderers.maleta(0);
        }

        function toggleDestino(idx) {
            state.destinos[idx].packing = !state.destinos[idx].packing;
            if(state.destinos[idx].packing) {
                sendAction(`¬°Sugerencia de ${state.destinos[idx].donor} lista! ‚úàÔ∏è`, true);
            }
            renderers.maleta(0);
        }

        function cerrarMaleta() {
            if(state.destinos.length === 0) return sendAction("¬°La maleta est√° vac√≠a!");
            const packed = state.destinos.some(d => d.packing);
            if(!packed) return sendAction("¬°Al menos mete un destino en la maleta!");
            
            state.maletaCerrada = true;
            sendAction("¬°Maleta cerrada! ¬°A correr por la cuadra! üèÉüí®", true);
            renderers.maleta(0);
        }

        function eatGrape(id) {
            const uva = state.uvas.find(u => u.id === id);
            if(!uva || uva.eaten) return;
            uva.eaten = true;
            state.grapesEaten++;
            const stat = document.getElementById('stat-grapes');
            if(stat) stat.innerText = state.grapesEaten;
            state.activeNote = uva;
            sendAction(`Deseo #${state.grapesEaten} lanzado ‚ú®`);
            renderers.uvas(0);
        }

        function saveWish(id, val) { state.uvas[id].wish = val; }

        function burnIt() {
            if(!state.quemar) return sendAction("¬°Escribe algo para quemar!");
            const deseo = prompt("¬øQu√© quieres para el 2026? (Tu deseo positivo)");
            if(deseo) state.deseos2026.push(deseo);
            state.quemar = "";
            sendAction("¬°Fuego! üß® El pasado se fue.", true);
            renderers.anoviejo(0);
        }

        function updateHelpersPanel() {
            const panel = document.getElementById('helpers-panel');
            const list = document.getElementById('helpers-list');
            if(!panel || !list) return;
            
            const totalHelpers = Object.values(state.helpersByBatch).reduce((acc, set) => acc + set.size, 0);

            if(totalHelpers > 0) {
                panel.classList.remove('hidden');
                panel.style.display = 'block';
                
                let html = "";
                const batchNumbers = Object.keys(state.helpersByBatch).sort((a,b) => b-a);
                
                batchNumbers.forEach(num => {
                    const batchSet = state.helpersByBatch[num];
                    if(batchSet.size > 0) {
                        html += `
                        <div>
                            <span class="batch-label">${num === state.currentBatchIndex.toString() ? 'Tanda Actual' : 'Tanda ' + num}</span>
                            <div class="flex flex-wrap gap-1">
                                ${Array.from(batchSet).map(h => `<span class="helper-tag">${h}</span>`).join('')}
                            </div>
                        </div>`;
                    }
                });
                list.innerHTML = html;
            } else {
                panel.style.display = 'none';
            }
        }

        function selectTradition(key) {
            state.currentTradition = key;
            state.activeNote = null;
            
            // Update UI Rings
            document.querySelectorAll('[id$="-ring"]').forEach(r => {
                if(r) {
                    r.classList.remove('bg-gradient-to-tr', 'from-green-400', 'to-yellow-500', 'from-blue-400', 'to-purple-500', 'from-purple-500', 'to-pink-500', 'from-red-500', 'to-orange-500');
                    r.classList.add('bg-white/10');
                }
            });
            
            const ring = document.getElementById(`nav-${key}-ring`);
            if(ring) {
                ring.classList.remove('bg-white/10');
                if(key === 'hallaca') ring.classList.add('bg-gradient-to-tr', 'from-green-400', 'to-yellow-500');
                if(key === 'maleta') ring.classList.add('bg-gradient-to-tr', 'from-blue-400', 'to-purple-500');
                if(key === 'uvas') ring.classList.add('bg-gradient-to-tr', 'from-purple-500', 'to-pink-500');
                if(key === 'anoviejo') ring.classList.add('bg-gradient-to-tr', 'from-red-500', 'to-orange-500');
            }

            const menu = document.getElementById('sub-menu');
            if(!menu) return;

            const subOptions = {
                hallaca: ["LISTA üìã", "ARMAR ü´î"],
                maleta: ["EQUIPAJE üß≥"],
                uvas: ["COMER üçá", "DESEOS üìù"],
                anoviejo: ["FOG√ìN üî•"]
            };
            menu.innerHTML = subOptions[key].map((s, i) => `
                <button onclick="changeTraditionMode('${key}', ${i})" class="px-6 py-3 rounded-2xl bg-white/5 border border-white/10 text-[9px] font-black uppercase tracking-widest transition-all">
                    ${s}
                </button>`).join('');
            changeTraditionMode(key, 0);
            updateHelpersPanel();
        }

        function changeTraditionMode(key, mode) {
            renderers[key](mode);
            document.querySelectorAll('#sub-menu button').forEach((b, i) => {
                const isMaleta = key === 'maleta';
                b.style.borderColor = i === mode ? (isMaleta ? '#3b82f6' : '#a855f7') : 'rgba(255,255,255,0.1)';
                b.style.color = i === mode ? '#fff' : '#666';
            });
            
            const showHelpers = (key === 'hallaca');
            const helpersPanel = document.getElementById('helpers-panel');
            if(helpersPanel) {
                helpersPanel.style.display = (showHelpers && Object.values(state.helpersByBatch).some(s => s.size > 0)) ? 'block' : 'none';
            }
        }

        window.onload = () => {
            setTimeout(() => {
                const splash = document.getElementById('splash');
                if(splash) {
                    splash.style.opacity = '0';
                    setTimeout(() => splash.style.display = 'none', 700);
                }
            }, 1000);
            selectTradition('hallaca');
            updateHelpersPanel();
        };
    </script>
</body>
</html>